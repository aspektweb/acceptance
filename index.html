<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Fortress | Shaxsiy Arxiv</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; display: flex; justify-content: center; padding: 20px; }
        .container { width: 100%; max-width: 600px; background: #1e293b; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { text-align: center; color: #38bdf8; }
        .input-group { margin-bottom: 15px; }
        input, textarea, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: none; background: #334155; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .btn-save { background: #0ea5e9; color: white; }
        .btn-view { background: #10b981; color: white; }
        .card { background: #334155; padding: 15px; margin-top: 15px; border-radius: 10px; border-left: 5px solid #38bdf8; }
        .media-preview { max-width: 100%; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ”’ Digital Fortress</h2>
    
    <div class="input-group">
        <label>Master Kod (Sizning kalitingiz):</label>
        <input type="password" id="masterPassword" placeholder="O'ta maxfiy kodni kiriting...">
    </div>

    <hr style="border: 0.5px solid #475569; margin: 20px 0;">

    <div class="input-group">
        <label>Sarlavha:</label>
        <input type="text" id="title" placeholder="Masalan: Pasport nusxasi">
    </div>

    <div class="input-group">
        <label>Ma'lumot turi:</label>
        <select id="type" onchange="toggleInputs()">
            <option value="text">Matnli qayd</option>
            <option value="image">Surat (Media)</option>
            <option value="audio">Ovozli xabar</option>
        </select>
    </div>

    <div id="textInput" class="input-group">
        <label>Matn:</label>
        <textarea id="textContent" rows="4" placeholder="Maxfiy xabarni yozing..."></textarea>
    </div>

    <div id="fileInput" class="input-group" style="display:none;">
        <label>Faylni tanlang:</label>
        <input type="file" id="mediaFile" accept="image/*,audio/*">
    </div>

    <button class="btn-save" onclick="saveToArchive()">Bunkerga saqlash</button>
    <button class="btn-view" onclick="loadArchive()">Arxivni ochish</button>

    <div id="archiveList"></div>
</div>

<script>
    // Inputlarni turiga qarab ko'rsatish
    function toggleInputs() {
        const type = document.getElementById('type').value;
        document.getElementById('textInput').style.display = type === 'text' ? 'block' : 'none';
        document.getElementById('fileInput').style.display = type !== 'text' ? 'block' : 'none';
    }

    // Faylni Base64 formatiga o'tkazish (shifrlash uchun)
    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    async function saveToArchive() {
        const pass = document.getElementById('masterPassword').value;
        const type = document.getElementById('type').value;
        const title = document.getElementById('title').value;
        let content = "";

        if (!pass) return alert("Avval Master kodni kiriting!");

        if (type === 'text') {
            content = document.getElementById('textContent').value;
        } else {
            const file = document.getElementById('mediaFile').files[0];
            if (!file) return alert("Faylni tanlang!");
            content = await toBase64(file);
        }

        const response = await fetch('/api/archive/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ payload: content, masterPassword: pass, type: type, title: title })
        });

        const resData = await response.json();
        alert(resData.message);
    }

    async function loadArchive() {
        const pass = document.getElementById('masterPassword').value;
        const response = await fetch('/api/archive/view', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ masterPassword: pass })
        });

        if (response.status === 401) return alert("Kod noto'g'ri!");

        const data = await response.json();
        const list = document.getElementById('archiveList');
        list.innerHTML = "";

        data.forEach(item => {
            let mediaHtml = "";
            if (item.type === 'image') mediaHtml = `<img src="${item.content}" class="media-preview">`;
            if (item.type === 'audio') mediaHtml = `<audio controls src="${item.content}"></audio>`;
            if (item.type === 'text') mediaHtml = `<p>${item.content}</p>`;

            list.innerHTML += `
                <div class="card">
                    <strong>${item.title}</strong> <small>(${item.type})</small>
                    <div style="margin-top:10px;">${mediaHtml}</div>
                    <small style="color: #94a3b8;">${item.createdAt}</small>
                </div>
            `;
        });
    }
</script>

</body>
</html>
